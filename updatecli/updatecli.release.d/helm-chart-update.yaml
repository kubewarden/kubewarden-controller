name: Update kubewarden-controller chart versions

sources:
  controllerChartVersion:
    name: "Get latest kubewarden-controller helm version"
    kind: yaml
    transformers:
      - semverinc: minor
    spec:
      file: charts/kubewarden-controller/Chart.yaml
      key: $.version
  crdsChartVersion:
    name: "Get latest kubewarden-crds helm version"
    kind: yaml
    transformers:
      - semverinc: minor
    spec:
      file: charts/kubewarden-crds/Chart.yaml
      key: $.version
  defaultsChartVersion:
    name: "Get latest kubewarden-defaults helm version"
    kind: yaml
    transformers:
      - semverinc: minor
    spec:
      file: charts/kubewarden-defaults/Chart.yaml
      key: $.version
  releaseVersion:
    name: "Get latest kubewarden-controller version"
    kind: githubrelease
    spec:
      owner: "{{ .github.owner }}"
      repository: kubewarden-controller
      typefilter:
        prerelease: true
        release: true
        draft: false
      versionfilter:
        kind: "semver"
        pattern: ">=0.0.0-0" # include pre-release, release
  readmeFile:
    kind: file
    spec:
      file: "./README.md"

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.author }}"
      email: "{{ .github.email }}"
      owner: "{{ .github.owner }}"
      repository: "kubewarden-controller"
      branch: "{{ .github.branch }}"
      commitusingapi: true
      commitmessage:
        squash: true
        type: "chore"
        title: "update kubewarden-controller Helm charts"
        hidecredit: true
        footers: "Signed-off-by: kubewarden-controller bot <kubewarden-controller-bot@users.noreply.github.com>"

actions:
  default:
    title: 'chore: Helm chart {{ source "controllerChartVersion" }} release'
    kind: github/pullrequest
    scmid: default
    spec:
      automerge: false
      mergemethod: squash
      description: |
        Automatic Helm chart {{ source "controllerChartVersion" }} update.
        This PR has been created by the automation used to automatically update the Helm charts when kubewarden-controller is released or helm chart content is updated.
        REMEMBER IF YOU WANT TO MERGE IN A SINGLE COMMIT CHANGES AND VERSION BUMP, YOU MUST SQUASH THE COMMIT BEFORE MERGING THIS PR!
      draft: false
      labels:
        - "chore"

targets:
  update_kubewarden_crds_helm_version:
    scmid: default
    name: Update Helm chart kubewarden-crds version
    kind: yaml
    sourceid: crdsChartVersion
    spec:
      file: charts/kubewarden-crds/Chart.yaml
      key: $.version
  update_kubewarden_crds_helm_appversion:
    scmid: default
    name: Update Helm chart kubewarden-crds appVersion
    kind: yaml
    sourceid: releaseVersion
    spec:
      file: charts/kubewarden-crds/Chart.yaml
      key: $.appVersion
  update_kubewarden_controller_helm_version:
    scmid: default
    name: Update Helm chart kubewarden-controller version
    kind: yaml
    sourceid: controllerChartVersion
    spec:
      file: charts/kubewarden-controller/Chart.yaml
      key: $.version
  update_kubewarden_controller_helm_appversion:
    scmid: default
    name: Update Helm chart kubewarden-controller appVersion
    kind: yaml
    sourceid: releaseVersion
    spec:
      file: charts/kubewarden-controller/Chart.yaml
      key: $.appVersion
  update_kubewarden_defaults_helm_version:
    scmid: default
    name: Update Helm chart kubewarden-defaults version
    kind: yaml
    sourceid: defaultsChartVersion
    spec:
      file: charts/kubewarden-crds/Chart.yaml
      key: $.version
  update_kubewarden_defaults_helm_appversion:
    scmid: default
    name: Update Helm chart kubewarden-defaults appVersion
    kind: yaml
    sourceid: releaseVersion
    spec:
      file: charts/kubewarden-defaults/Chart.yaml
      key: $.appVersion
  update_controller_image_tag:
    scmid: default
    name: Update Helm chart kubewarden-controller image tag
    kind: yaml
    sourceid: releaseVersion
    spec:
      file: charts/kubewarden-controller/values.yaml
      key: $.image.tag
  update_audit_scanner_image_tag:
    scmid: default
    name: Update Helm chart audit-scanner version
    kind: yaml
    sourceid: releaseVersion
    spec:
      file: charts/kubewarden-controller/values.yaml
      key: $.auditScanner.image.tag
  update_policy_server_image_tag:
    scmid: default
    name: Update Helm chart policy-server version
    kind: yaml
    sourceid: releaseVersion
    spec:
      file: charts/kubewarden-defaults/values.yaml
      key: $.policyServer.image.tag
  update_readme:
    scmid: default
    kind: file
    sourceid: readmeFile
    spec:
      file: charts/kubewarden-controller/README.md
      forcecreate: true
  generate_values_schema:
    kind: shell
    disablesourceinput: true
    scmid: default
    name: Generate values.schema.json file
    spec:
      changedif:
        kind: file/checksum
        spec:
          files:
            - charts/kubewarden-controller/values.schema.json
      command: |
        make generate-chart
