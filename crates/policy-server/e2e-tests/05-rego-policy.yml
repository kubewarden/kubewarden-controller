name: Rego policy execution

testcases:

- name: fixtures
  steps:
  - type: readfile
    path: ./test_data/service-clusterip.json
    assertions:
    - result.err ShouldBeEmpty
    vars:
      service_cluster_ip:
        from: result.content
  - type: readfile
    path: ./test_data/service_loadbalancer.json
    assertions:
    - result.err ShouldBeEmpty
    vars:
      service_loadbalancer:
        from: result.content

- name: Rego-based policies work as expected
  steps:
  - name: Send violating request
    type: http
    method: POST
    url: http://localhost:3000/validate/disallow-service-loadbalancer
    headers:
      Content-Type: application/json
    body: "{{ .fixtures.service_loadbalancer }}"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.response.allowed ShouldEqual false
    - result.bodyjson.response.status.code ShouldNotEqual 500
  - name: Send non violating request
    type: http
    method: POST
    url: http://localhost:3000/validate/disallow-service-loadbalancer
    headers:
      Content-Type: application/json
    body: "{{ .fixtures.service_cluster_ip }}"
    assertions:
    - result.statuscode ShouldEqual 200
    - result.bodyjson.response.allowed ShouldEqual true
